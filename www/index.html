<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koulun Ruokalista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .menu-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .filter-btn {
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-up {
            animation: fadeInUp 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-10">
    <div class="max-w-xl mx-auto">
        <!-- Otsikko -->
        <header class="mb-8 text-center">
            <div class="inline-block p-3 bg-blue-100 rounded-full mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Lohjan Kouluruoka</h1>
            <p class="text-gray-500 mt-2">P√§ivitt√§inen ruokalista suoraan koululta</p>
            
            <button onclick="fetchMenu()" class="mt-6 inline-flex items-center px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all shadow-sm active:scale-95">
                <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                P√§ivit√§ ruokalistaa
            </button>
        </header>

        <!-- Suodattimet -->
        <div class="mb-8 p-1 bg-gray-100 rounded-xl flex flex-wrap justify-between gap-1 shadow-inner">
            <button onclick="setFilter('kaikki')" id="btn-kaikki" class="filter-btn flex-1 py-2.5 text-xs font-bold rounded-lg border border-transparent transition-all">KAIKKI</button>
            <button onclick="setFilter('aamupala')" id="btn-aamupala" class="filter-btn flex-1 py-2.5 text-xs font-bold rounded-lg border border-transparent transition-all">AAMUPALA</button>
            <button onclick="setFilter('lounas')" id="btn-lounas" class="filter-btn active flex-1 py-2.5 text-xs font-bold rounded-lg border border-transparent transition-all">LOUNAS</button>
            <button onclick="setFilter('v√§lipala')" id="btn-v√§lipala" class="filter-btn flex-1 py-2.5 text-xs font-bold rounded-lg border border-transparent transition-all">V√ÑLIPALA</button>
        </div>

        <!-- Lataustila -->
        <div id="loader" class="flex flex-col items-center justify-center py-20">
            <div class="relative w-12 h-12">
                <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-100 rounded-full"></div>
                <div class="absolute top-0 left-0 w-full h-full border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p class="mt-4 text-gray-400 font-medium text-sm">Etsit√§√§n ruokalistaa...</p>
        </div>

        <!-- P√§√§sis√§lt√∂ -->
        <main id="content" class="hidden space-y-6">
            <div id="menu-container" class="space-y-6"></div>
            
            <div id="show-more-container" class="hidden text-center pt-4">
                <button onclick="showAllDays()" class="inline-flex items-center px-6 py-3 bg-white border border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all shadow-sm active:bg-gray-100">
                    N√§yt√§ koko viikko
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
        </main>

        <!-- Virheilmoitus (vain jos haku todella ep√§onnistuu) -->
        <div id="notice-box" class="hidden mt-8 p-4 bg-amber-50 border border-amber-200 rounded-xl flex items-start space-x-3 animate-fade-up">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <div class="w-full">
                <h3 class="text-sm font-bold text-amber-800">Yhteysongelma</h3>
                <p id="error-message" class="text-xs text-amber-700 mt-1 leading-relaxed">
                    Ruokalistaa ei saatu noudettua juuri nyt. Kokeile p√§ivitt√§√§ sivu hetken kuluttua.
                </p>
            </div>
        </div>

        <footer class="mt-16 pb-8 text-center text-xs text-gray-400">
            <p>&copy; Ruokalista v3.5</p>
            <p class="mt-1">ilaro2024 2026</p>
        </footer>
    </div>

    <script>
        const rssUrl = "https://eruokalista.lohja.fi/AromieMenus/FI/Default/Lohja/Koulut/api/Common/Restaurant/GetRssFeed/0d4884d5-33be-4e09-82ee-66153fa4a749/1";
        
        let allItems = [];
        let currentFilter = 'lounas';
        let isShowingAllDays = false;

        const proxyUrls = [
            (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&ts=${Date.now()}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];

        async function fetchMenu(proxyIndex = 0) {
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            const refreshIcon = document.getElementById('refresh-icon');
            const noticeBox = document.getElementById('notice-box');

            const targetUrl = proxyUrls[proxyIndex](rssUrl);
            
            if (proxyIndex === 0) {
                loader.classList.remove('hidden');
                content.classList.add('hidden');
                noticeBox.classList.add('hidden'); 
                refreshIcon.classList.add('animate-spin');
                allItems = [];
            }

            try {
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error(); // Heitet√§√§n virhe hiljaa
                
                let rawData = "";
                if (proxyIndex === 0) {
                    const json = await response.json();
                    rawData = json.contents;
                } else {
                    rawData = await response.text();
                }

                if (rawData && typeof rawData === 'string') {
                    rawData = rawData.trim();
                    const rssIndex = rawData.indexOf('<rss');
                    const xmlIndex = rawData.indexOf('<?xml');
                    let start = (xmlIndex !== -1 && (rssIndex === -1 || xmlIndex < rssIndex)) ? xmlIndex : rssIndex;
                    if (start !== -1) rawData = rawData.substring(start);
                }

                if (!rawData || !rawData.includes('<rss')) throw new Error();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rawData, "text/xml");
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error();

                const items = Array.from(xmlDoc.getElementsByTagName("item"));
                if (items.length === 0) throw new Error();

                // Jos p√§√§st√§√§n t√§nne, haku onnistui
                allItems = items;
                renderMenu();
                content.classList.remove('hidden');
                loader.classList.add('hidden');
                noticeBox.classList.add('hidden');
                refreshIcon.classList.remove('animate-spin');
                
                if (allItems.length > 1 && !isShowingAllDays) {
                    document.getElementById('show-more-container').classList.remove('hidden');
                }
            } catch (e) { 
                // Ei tulosteta mit√§√§n konsoliin t√§ss√§ vaiheessa, jos on viel√§ proxy-vaihtoehtoja j√§ljell√§
                if (proxyIndex < proxyUrls.length - 1) {
                    setTimeout(() => fetchMenu(proxyIndex + 1), 300);
                } else {
                    // Vasta jos KAIKKI ep√§onnistuvat, n√§ytet√§√§n virhe k√§ytt√§j√§lle
                    loader.classList.add('hidden');
                    refreshIcon.classList.remove('animate-spin');
                    noticeBox.classList.remove('hidden');
                }
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${filter}`).classList.add('active');
            if (allItems.length > 0) renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            const displayItems = isShowingAllDays ? allItems : allItems.slice(0, 1);

            displayItems.forEach((item) => {
                const title = item.getElementsByTagName("title")[0]?.textContent || "P√§iv√§";
                const description = item.getElementsByTagName("description")[0]?.textContent || "";
                const mealOptions = description.split('<br><br>').filter(opt => opt.trim() !== "");
                
                const filteredMeals = mealOptions.filter(option => {
                    if (currentFilter === 'kaikki') return true;
                    return option.toLowerCase().includes(currentFilter.toLowerCase());
                });

                if (filteredMeals.length === 0) return;

                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden menu-card animate-fade-up";
                
                let mealsHtml = filteredMeals.map(option => {
                    const lines = option.split('<br>');
                    const titleLine = lines[0];
                    const components = lines.slice(1).join(' ‚Ä¢ ');
                    const label = titleLine.includes(':') ? titleLine.split(':')[0] : "Lounas";
                    const dish = titleLine.includes(':') ? titleLine.split(':')[1] : titleLine;

                    let badgeColor = "bg-blue-50 text-blue-700";
                    if (label.toLowerCase().includes("aamu")) badgeColor = "bg-orange-50 text-orange-700";
                    if (label.toLowerCase().includes("v√§li")) badgeColor = "bg-purple-50 text-purple-700";

                    return `
                        <div class="p-6 border-b last:border-0 border-gray-50">
                            <span class="inline-block px-2 py-0.5 ${badgeColor} text-[10px] font-bold uppercase tracking-wider rounded mb-2">${label}</span>
                            <h3 class="text-lg font-bold text-gray-900 leading-tight">${dish}</h3>
                            ${components ? `<p class="mt-2 text-sm text-gray-400 leading-relaxed font-medium">${components}</p>` : ''}
                        </div>
                    `;
                }).join('');

                card.innerHTML = `
                    <div class="bg-gray-50/50 px-6 py-3 border-b border-gray-100">
                        <div class="flex items-center text-xs font-bold text-gray-400 uppercase tracking-widest">
                            <span class="mr-2 text-sm">üìÖ</span> ${title}
                        </div>
                    </div>
                    <div class="divide-y divide-gray-50">${mealsHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        function showAllDays() {
            isShowingAllDays = true;
            renderMenu();
            document.getElementById('show-more-container').classList.add('hidden');
        }

        window.onload = () => fetchMenu();
    </script>
</body>
</html>

